<?php
if (!isset($assocId)) {
	$assocId = 'risk-asset-id';
}
if (!isset($url)) {
	$url = "/risks/getThreatsVulnerabilities";
}
?>
<script type="text/javascript">
	jQuery(function($) {
		$("#<?php echo $assocId; ?>").off("change.AutoComplete.Eramba").on("change.AutoComplete.Eramba", function(e) {
			var assetIds = [];
			$.each($("#<?php echo $assocId; ?> option:selected"), function(i, e) {
				assetIds.push($(e).val());
			});

			getAssetsRelatedThreatsVulnerabilities(assetIds);
		});

		var assetDefinedThreats = [];
		var assetDefinedVulnerabilities = [];
		function getAssetsRelatedThreatsVulnerabilities(assetIds) {
			$.ajax({
				url: "<?php echo $url; ?>",
				type: "POST",
				dataType: "JSON",
				data: {
					assocIds: JSON.stringify(assetIds)
				},
				beforeSend: function( xhr ) {
				}
			})
			.done(function(data) {
				if (data.threats.length) {
					assetDefinedThreats = assetDefinedThreats.concat(data.threats);

					var arr = $("#risk-threat-id").val() || [];
					var newArr = arr.concat(data.threats);
					 $("#risk-threat-id").val(newArr).trigger("change");
				}
				else {
					var threats = $("#risk-threat-id").val() || [];
					var userValues = $.map( threats, function( n ) {
						if (assetDefinedThreats.indexOf(n) != -1) {
							return null;
						}

						return n;
					});

					$("#risk-threat-id").val(userValues).trigger("change");
				}

				if (data.vulnerabilities.length) {
					assetDefinedVulnerabilities = assetDefinedVulnerabilities.concat(data.vulnerabilities);

					var arr = $("#risk-vulnerability-id").val() || [];
					var newArr = arr.concat(data.vulnerabilities);
					 $("#risk-vulnerability-id").val(newArr).trigger("change");
				}
				else {
					var vulnerabilities = $("#risk-vulnerability-id").val() || [];
					var userValues = $.map( vulnerabilities, function( n ) {
						if (assetDefinedVulnerabilities.indexOf(n) != -1) {
							return null;
						}

						return n;
					});

					$("#risk-vulnerability-id").val(userValues).trigger("change");
				}
			});
		}
	});
</script>